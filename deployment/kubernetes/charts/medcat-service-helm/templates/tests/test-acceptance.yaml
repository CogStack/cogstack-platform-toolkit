apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "medcat-service.fullname" . }}-test-acceptance"
  labels:
    {{- include "medcat-service.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "2"
spec:
  containers:
    - name: curl-test
      image: curlimages/curl:latest
      securityContext:
        runAsUser: 0
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          apk add --no-cache jq


          api="{{ include "medcat-service.fullname" . }}:{{ .Values.service.port }}/api/process"
          input_text="The patient was diagnosed with Kidney Failure"
          input_payload="{\"content\":{\"text\":\"${input_text}\"}}"
          expected_annotation="Kidney Failure"

          echo "Calling POST $api with payload '$input_payload'"
          actual=$(curl -s -X POST "$api" \
            -H 'Content-Type: application/json' \
            --user-agent 'helm-test {{ .Chart.Name }}-v{{ .Chart.Version }}' \
            -d "$input_payload")

          echo "Received result '$actual'"

          actual_annotation=$(echo "$actual" | jq -r '.result.annotations[0]["0"].pretty_name')
          echo "Expected Annotation is '${expected_annotation}'. Actual Annotation is '${actual_annotation}'"
          
          if [ "$actual_annotation" = "$expected_annotation" ]; then
            echo "Service working and extracting annotations"
          else
            echo "Expected: $expected_annotation, Got: $actual_annotation"
            echo -e "Actual response was:\n${actual}"
            exit 1
          fi
  restartPolicy: Never